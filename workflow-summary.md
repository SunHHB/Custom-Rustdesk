# Custom RustDesk 构建工作流 - 阶段总结

## 工作流概览

整个构建工作流包含6个主要阶段，采用三锁架构确保并发安全：

1. **Trigger** - 参数提取和验证
2. **Review** - 审核和权限检查  
3. **Join-Queue** - 加入构建队列
4. **Wait-Build-Lock** - 获取构建锁
5. **Build** - 执行构建过程
6. **Finish** - 清理和通知

## 各阶段详细流程

### 1. Trigger阶段
**目的**: 提取和验证构建参数

**流程**:
```
事件触发 → 参数提取 → 应用默认值 → 处理tag → 生成JSON → 验证参数 → 输出结果
```

**关键操作**:
- 从`workflow_dispatch`或`issues`事件提取参数
- 应用默认值配置
- 为tag添加时间戳
- 生成包含`build_params`的JSON结构
- 验证必要参数（如email）

**输出**: `trigger_data`, `build_id`, `validation_passed`

### 2. Review阶段
**目的**: 审核和权限验证

**流程**:
```
获取参数 → 验证参数 → 检查审核需求 → 清理issue → 处理审核 → 输出结果
```

**关键操作**:
- 验证服务器参数（IP地址、域名等）
- 检查是否需要管理员审核
- **无论是否需要审核，都清理issue中的敏感信息**
- **如果需要审核，在issue中回复需要审核的信息**
- 处理审核流程（等待、超时、拒绝）

**输出**: `review_passed`, `review_reason`

### 3. Join-Queue阶段
**目的**: 使用三锁架构加入构建队列

**流程**:
```
确定ID → 获取Issue锁 → 获取队列锁 → 检查队列 → 添加项目 → 释放锁 → 返回位置
```

**关键操作**:
- 使用三锁架构确保并发安全
- 检查队列是否已满（最大3个项目）
- 添加新项目到队列
- 返回队列位置

**输出**: `join_success`, `queue_position`

### 4. Wait-Build-Lock阶段
**目的**: 获取构建锁以开始构建

**流程**:
```
确定ID → 获取构建锁 → 返回结果
```

**关键操作**:
- 等待构建锁可用
- 获取构建锁

**输出**: `build_lock_acquired`

### 5. Build阶段
**目的**: 执行实际的构建过程

**流程**:
```
提取参数 → 验证参数 → 执行构建 → 生成结果 → 输出状态
```

**关键操作**:
- 从`build_params`提取构建参数
- 模拟构建过程（准备环境、同步代码、编译、打包）
- 生成下载URL
- 记录构建时间

**输出**: `build_success`, `download_url`, `error_message`

### 6. Finish阶段
**目的**: 清理资源和发送通知

**流程**:
```
确定状态 → 获取参数 → 清理环境 → 释放锁 → 输出结果 → 发送通知
```

**关键操作**:
- 确定构建成功/失败状态
- 清理构建环境
- 释放三锁架构的所有锁
- 发送邮件通知（成功/失败都发送）

**输出**: `finish_status`, `notification_sent`, `cleanup_completed`, `lock_released`

## 三锁架构

系统使用三个锁确保并发安全：

1. **Issue锁** - 保护Issue操作
2. **队列锁** - 保护队列数据
3. **构建锁** - 控制构建执行

**锁获取顺序**: Issue锁 → 队列锁 → 构建锁
**锁释放顺序**: 构建锁 → 队列锁 → Issue锁

## 数据流

```
GitHub Event → trigger_data → build_params → 队列数据 → 构建结果 → 完成状态
```

**关键数据结构**:
- `trigger_data`: 包含`build_params`、`build_id`、`trigger_type`等
- `build_params`: 包含所有构建参数（tag、email、customer等）
- 队列数据: 存储在Issue #1中

## 错误处理

每个阶段都有完整的错误处理机制：

- **参数验证失败**: 在issue中回复错误信息
- **队列已满**: 返回队列满错误
- **锁获取失败**: 重试或放弃
- **构建失败**: 记录错误并继续到finish阶段
- **通知发送失败**: 记录但继续执行

## 关键特性

1. **并发安全**: 三锁架构确保多用户并发安全
2. **容错性**: 每个阶段都有错误处理和恢复机制
3. **可观测性**: 详细的日志和状态输出
4. **灵活性**: 支持手动触发和Issue触发两种方式
5. **审核机制**: 支持管理员审核和自动审核
6. **通知系统**: 构建完成后的邮件通知

## 执行顺序

```
Trigger → Review → Join-Queue → Wait-Build-Lock → Build → Finish
```

每个阶段都依赖于前一个阶段的成功输出，确保流程的完整性和可靠性。 