# Custom Rustdesk 工作流测试工具总结

## 📋 项目概述

基于对 Custom Rustdesk 构建工作流的深入理解，我创建了一套完整的测试工具，用于模拟真实数据、触发工作流并使用 gh 命令跟踪工作流运行情况。

## 🔧 工作流理解

### 工作流架构
Custom Rustdesk 构建工作流包含以下5个主要阶段：

1. **触发处理 (trigger)** - 从 issue 或手动触发中提取和验证参数
2. **审核验证 (review)** - 验证参数并处理审核流程
3. **队列管理 (join-queue)** - 使用三锁架构管理构建队列
4. **等待构建锁 (wait-build-lock)** - 获取构建权限
5. **构建执行 (build)** - 执行实际的构建过程
6. **完成处理 (finish)** - 清理和通知

### 关键特性
- **三锁架构**: 使用 issue 锁、队列锁、构建锁确保并发安全
- **参数验证**: 严格的参数验证和默认值处理
- **审核机制**: 支持自动审核和人工审核
- **队列管理**: 智能队列管理，避免资源冲突
- **通知系统**: 构建完成后自动发送邮件通知

## 🛠️ 测试工具

### 1. 完整测试脚本 (`test_workflow.sh`)
**功能**: 完整的测试套件，支持所有测试场景
- ✅ 真实数据模拟
- ✅ 多种触发方式 (workflow_dispatch + issue)
- ✅ 实时状态监控
- ✅ 日志下载和分析
- ✅ 结果分析
- ✅ 资源清理

### 2. 简化测试脚本 (`simple_test.sh`)
**功能**: 简化版本，专注于核心功能测试
- ✅ 基础依赖检查
- ✅ 工作流触发测试
- ✅ 状态监控
- ✅ 结果验证

### 3. 快速测试脚本 (`quick_test.sh`)
**功能**: 快速验证基本功能
- ✅ 一键测试
- ✅ 快速反馈
- ✅ 基础监控

## 📊 测试数据模拟

### 生成的测试参数
每次测试都会生成唯一的参数，避免冲突：

```json
{
  "tag": "test-build-1703123456",
  "customer": "测试客户-1703123456",
  "email": "test-1703123456@example.com",
  "super_password": "testpass1703123456",
  "rendezvous_server": "192.168.1.100",
  "api_server": "http://192.168.1.100:21114",
  "slogan": "测试标语-1703123456",
  "customer_link": "https://example.com/test-1703123456",
  "rs_pub_key": "",
  "enable_debug": true
}
```

### Issue 触发格式
当使用 issue 触发时，会创建标准格式的 issue：

```markdown
## 构建参数

- **标签**: test-build-1703123456
- **客户**: 测试客户-1703123456
- **邮箱**: test-1703123456@example.com
- **标语**: 测试标语-1703123456
- **超级密码**: testpass1703123456
- **Rendezvous服务器**: 192.168.1.100
- **API服务器**: http://192.168.1.100:21114
- **客户链接**: https://example.com/test-1703123456
- **RS公钥**: 

## 构建请求

请为上述参数构建自定义Rustdesk版本。

构建ID: test-1703123456
```

## 🚀 使用方法

### 前置要求
```bash
# 安装依赖
sudo apt install gh jq

# 登录 GitHub CLI
gh auth login
```

### 运行测试
```bash
# 快速测试
./quick_test.sh

# 简化测试
./simple_test.sh

# 完整测试
./test_workflow.sh
```

## 📈 监控和跟踪

### 实时状态监控
脚本会实时显示工作流运行状态：

```
[INFO] 状态: in_progress, 结论: null
[INFO] 运行URL: https://github.com/user/repo/actions/runs/123456789
[INFO] 作业状态:
  - trigger: completed (success)
  - review: completed (success)  
  - join-queue: completed (success)
  - wait-build-lock: completed (success)
  - build: in_progress (running)
  - finish: queued (null)
```

### 日志分析
自动下载和分析工作流运行日志：

```
[INFO] 下载工作流运行日志...
[SUCCESS] 日志已下载到目录: workflow_logs_123456789
[INFO] 日志文件列表:
  - workflow_logs_123456789/trigger/1_Checkout_code.txt
  - workflow_logs_123456789/trigger/2_Process_trigger_and_validate_parameters.txt
  - workflow_logs_123456789/review/1_Checkout_code.txt
  - workflow_logs_123456789/review/2_Review_and_validate.txt
```

### 结果分析
详细分析工作流运行结果：

```
[INFO] 运行详情:
  - 状态: completed
  - 结论: success
  - 运行URL: https://github.com/user/repo/actions/runs/123456789
[INFO] 作业结果分析:
  - trigger: completed (success)
  - review: completed (success)
  - join-queue: completed (success)
  - wait-build-lock: completed (success)
  - build: completed (success)
  - finish: completed (success)
[SUCCESS] 所有步骤都成功完成
```

## 🔍 故障排除

### 常见问题及解决方案

1. **GitHub CLI 未登录**
   ```bash
   gh auth login
   ```

2. **权限不足**
   - 确保有 `issues: write` 和 `actions: read` 权限

3. **工作流未找到**
   - 确保在正确的仓库中运行
   - 检查工作流文件是否存在

4. **监控超时**
   - 检查工作流配置
   - 调整超时时间

### 调试技巧
```bash
# 查看工作流列表
gh workflow list

# 查看特定工作流
gh workflow view .github/workflows/CustomBuildRustdesk.yml

# 查看运行历史
gh run list --workflow=CustomBuildRustdesk.yml

# 查看特定运行
gh run view <run_id>
```

## 📝 测试场景

### 1. workflow_dispatch 触发测试
- 直接使用 `gh workflow run` 命令触发
- 验证所有输入参数的正确传递
- 测试参数验证和默认值处理

### 2. issue 触发测试
- 创建标准格式的 issue
- 验证 issue 内容解析
- 测试自动触发机制

### 3. 并发测试
- 同时触发多个构建请求
- 验证三锁架构的并发控制
- 测试队列管理机制

### 4. 错误处理测试
- 测试无效参数的处理
- 验证错误通知机制
- 测试资源清理

## 🎯 测试覆盖

### 功能覆盖
- ✅ 参数提取和验证
- ✅ 工作流触发机制
- ✅ 状态监控和跟踪
- ✅ 日志收集和分析
- ✅ 结果验证和报告
- ✅ 资源清理

### 场景覆盖
- ✅ 正常流程测试
- ✅ 错误处理测试
- ✅ 并发测试
- ✅ 超时处理测试

## 📚 文档

### 使用说明
- `README_TEST.md` - 详细的使用说明和故障排除指南

### 脚本说明
- `test_workflow.sh` - 完整测试脚本
- `simple_test.sh` - 简化测试脚本
- `quick_test.sh` - 快速测试脚本

## 🔄 持续改进

### 建议改进
1. **性能优化**: 优化监控间隔和超时设置
2. **错误处理**: 增强错误处理和恢复机制
3. **报告生成**: 生成详细的测试报告
4. **集成测试**: 集成到 CI/CD 流程中

### 扩展功能
1. **批量测试**: 支持批量运行多个测试
2. **压力测试**: 模拟高并发场景
3. **回归测试**: 自动化回归测试
4. **性能基准**: 建立性能基准测试

## 📞 支持

如有问题或建议，请：
1. 查看 `README_TEST.md` 中的故障排除部分
2. 检查 GitHub Actions 运行日志
3. 提交 Issue 或 Pull Request

---

**总结**: 这套测试工具提供了完整的 Custom Rustdesk 工作流测试解决方案，能够有效验证工作流的各个组件和功能，确保构建系统的稳定性和可靠性。 