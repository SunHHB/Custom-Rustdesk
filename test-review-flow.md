# Review阶段流程测试

## 修改总结

根据用户要求，review阶段的逻辑已经修改为：

### 1. Issue内容清理逻辑
**修改前**：
- 只有在验证通过且是issue触发时才清理issue内容

**修改后**：
- **无论是否需要审核，都清理issue内容**
- 清理操作在检查是否需要审核之后立即执行

### 2. 审核通知逻辑
**修改前**：
- 如果需要审核，没有在issue中回复需要审核的信息

**修改后**：
- **如果需要审核，在issue中回复需要审核的信息**
- 使用新的`generate_review_required_template`函数生成审核通知

## 新的执行流程

### 场景1：不需要审核
```
1. 验证参数 → 成功
2. 检查是否需要审核 → 不需要
3. 清理issue内容（如果是issue触发）
4. 设置review_passed=true
5. 输出结果
```

### 场景2：需要审核
```
1. 验证参数 → 成功
2. 检查是否需要审核 → 需要
3. 清理issue内容（如果是issue触发）
4. 在issue中回复需要审核的信息
5. 处理审核流程（等待、超时、拒绝）
6. 根据审核结果设置review_passed
7. 输出结果
```

### 场景3：验证失败
```
1. 验证参数 → 失败
2. 在issue中回复错误信息
3. 设置review_passed=false
4. 结束review
```

## 新增的模板函数

### `generate_review_required_template`
- **参数**：`run_id`, `issue_id`, `trigger_data`
- **功能**：生成需要审核的通知模板
- **内容**：包含构建参数、审核原因、审核操作说明、超时信息

## 测试用例

### 测试用例1：Issue触发 + 不需要审核
**输入**：
- 事件类型：issues
- 服务器地址：公网IP或域名
- 其他参数：正常

**预期结果**：
1. ✅ 验证通过
2. ✅ 不需要审核
3. ✅ 清理issue内容
4. ✅ review_passed=true

### 测试用例2：Issue触发 + 需要审核
**输入**：
- 事件类型：issues
- 服务器地址：私有IP
- 其他参数：正常

**预期结果**：
1. ✅ 验证通过
2. ✅ 需要审核
3. ✅ 清理issue内容
4. ✅ 在issue中回复需要审核的信息
5. ✅ 等待审核结果

### 测试用例3：手动触发 + 需要审核
**输入**：
- 事件类型：workflow_dispatch
- 服务器地址：私有IP
- 其他参数：正常

**预期结果**：
1. ✅ 验证通过
2. ✅ 需要审核
3. ✅ 不清理issue内容（非issue触发）
4. ✅ 不回复审核信息（非issue触发）
5. ✅ 等待审核结果

### 测试用例4：验证失败
**输入**：
- 事件类型：issues
- 服务器地址：无效格式
- 其他参数：正常

**预期结果**：
1. ❌ 验证失败
2. ✅ 在issue中回复错误信息
3. ✅ review_passed=false
4. ❌ 不清理issue内容（验证失败）
5. ❌ 不检查审核需求

## 验证要点

1. **Issue清理时机**：无论是否需要审核，都在检查审核需求后立即清理
2. **审核通知**：只有在需要审核且是issue触发时才发送审核通知
3. **错误处理**：验证失败时不会清理issue内容，保持原始信息供用户查看
4. **状态设置**：各种情况下都正确设置review_passed和review_reason 