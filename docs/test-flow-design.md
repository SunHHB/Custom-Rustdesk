# 高并发队列测试流程设计文档

## 1. 测试目标

### 1.1 主要目标
测试队列管理系统在高并发情况下的：
- 队列生成机制
- 锁竞争处理
- 顺序构建执行
- 限制策略执行

### 1.2 具体验证点
- ✅ 7个任务同时触发（高并发启动）
- ✅ 队列限制策略正确执行（issue限制3个，手动限制2个）
- ✅ 构建锁顺序获取（一次只能有一个构建）
- ✅ 队列状态正确维护

## 2. 测试场景设计

### 2.1 任务配置
```
任务类型          | 数量 | 预期结果
Issue触发        | 4个  | 前3个成功，第4个被拒绝
手动触发         | 3个  | 前2个成功，第3个被拒绝
总计            | 7个  | 5个成功，2个被拒绝
```

### 2.2 队列策略
- **总队列限制**：5个
- **Issue触发限制**：3个
- **手动触发限制**：2个
- **构建锁**：1个（互斥）

## 3. 测试流程设计

### 3.1 阶段1：高并发启动
```
时间点: T0
操作: 同时启动7个任务
预期: 所有任务开始执行，竞争资源
```

### 3.2 阶段2：队列生成
```
时间点: T0+1s
操作: 任务尝试加入队列
预期: 
- Issue任务1-3成功加入队列
- Issue任务4被拒绝（达到issue限制）
- 手动任务1-2成功加入队列  
- 手动任务3被拒绝（达到手动限制）
```

### 3.3 阶段3：构建锁竞争
```
时间点: T0+2s
操作: 队列中的任务竞争构建锁
预期: 只有一个任务获得构建锁，其他等待
```

### 3.4 阶段4：顺序构建
```
时间点: T0+3s 到 T0+15s
操作: 任务依次获取构建锁、执行构建、释放锁
预期: 任务按队列顺序逐个执行构建
```

### 3.5 阶段5：队列清理
```
时间点: T0+16s
操作: 构建完成的任务离开队列
预期: 队列逐渐清空，最终长度为0
```

## 4. 实现策略

### 4.1 高并发实现
```bash
# 使用后台进程实现真正的高并发
for task in "${tasks[@]}"; do
    simulate_task "$task" &
    pids+=($!)
done

# 等待所有任务完成
wait "${pids[@]}"
```

### 4.2 队列状态监控
```bash
# 定期检查队列状态
while [ $active_tasks -gt 0 ]; do
    queue_status=$(get_queue_status)
    log_queue_state "$queue_status"
    sleep 1
done
```

### 4.3 结果验证
```bash
# 验证最终状态
verify_queue_empty
verify_issue_limit_respected
verify_manual_limit_respected
verify_build_sequence
```

## 5. 预期测试结果

### 5.1 成功指标
- [ ] 7个任务同时启动
- [ ] 队列正确生成（5个任务）
- [ ] 限制策略正确执行（2个被拒绝）
- [ ] 构建锁顺序获取
- [ ] 所有任务完成
- [ ] 队列最终清空

### 5.2 性能指标
- 启动时间：< 1秒
- 队列生成时间：< 2秒
- 构建执行时间：按配置（默认60秒）
- 总测试时间：< 70秒

## 6. 问题诊断策略

### 6.1 日志分析
- 启用DEBUG模式
- 记录关键时间点
- 监控锁状态变化
- 跟踪队列数据变化

### 6.2 状态检查点
- T0: 任务启动
- T0+1s: 队列生成
- T0+2s: 构建锁竞争
- T0+3s: 构建开始
- T0+15s: 构建完成
- T0+16s: 队列清理

## 7. 实现步骤

### 7.1 第一步：修复基础问题
- [x] 修复队列限制检查逻辑
- [x] 改进构建锁重试机制
- [x] 启用调试日志

### 7.2 第二步：实现高并发
- [ ] 修改测试脚本为真正的高并发
- [ ] 添加队列状态监控
- [ ] 实现结果验证

### 7.3 第三步：完善测试流程
- [ ] 添加时间点检查
- [ ] 实现状态验证
- [ ] 添加性能指标

### 7.4 第四步：测试和优化
- [ ] 运行完整测试
- [ ] 分析测试结果
- [ ] 优化性能
- [ ] 文档化测试流程

## 8. 风险评估

### 8.1 技术风险
- **锁竞争**：高并发可能导致死锁
- **数据一致性**：队列数据可能不一致
- **性能瓶颈**：GitHub API调用可能成为瓶颈

### 8.2 缓解措施
- 使用超时机制防止死锁
- 实现乐观锁保证数据一致性
- 添加API缓存减少调用次数

## 9. 成功标准

测试成功的标准：
1. ✅ 7个任务同时启动
2. ✅ 队列正确生成（5个任务）
3. ✅ 限制策略正确执行
4. ✅ 构建锁顺序获取
5. ✅ 所有任务完成
6. ✅ 队列最终清空
7. ✅ 测试时间在预期范围内

## 10. 下一步行动

1. **立即行动**：基于此设计文档重新实现测试脚本
2. **优先级**：先实现高并发，再完善监控和验证
3. **时间安排**：预计2-3个迭代完成完整实现
